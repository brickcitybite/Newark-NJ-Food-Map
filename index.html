<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <title>Restaurant Guide</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <link href="https://api.mapbox.com/mapbox-gl-js/v3.16.0/mapbox-gl.css" rel="stylesheet">
  <script src="https://api.mapbox.com/mapbox-gl-js/v3.16.0/mapbox-gl.js"></script>
  <style>
    body { margin: 0; padding: 0; font-family: sans-serif; }
    #map { position: absolute; top: 0; bottom: 0; width: 100%; }

    #cuisineFilter {
      position: absolute;
      top: 10px;
      left: 10px;
      z-index: 2;
      padding: 5px;
      font-size: 14px;
      border: 1px solid #ccc;
      border-radius: 4px;
      background: white;
    }

    #sidebar {
      position: absolute;
      top: 50px;
      left: 10px;
      z-index: 2;
      width: 220px;
      max-height: 70vh;
      overflow-y: auto;
      background: rgba(255, 255, 255, 0.95);
      border-radius: 4px;
      padding: 6px;
      font-size: 13px;
      box-shadow: 0 0 4px rgba(0,0,0,0.2);
    }

    .restaurant-item {
      margin-bottom: 6px;
      padding: 4px;
      border-bottom: 1px solid #ddd;
      cursor: pointer;
    }
    .restaurant-item:hover { background: #f0f0f0; }

    .mapboxgl-popup-content {
      max-width: 220px;
      padding: 6px;
      font-size: 12px;
      line-height: 1.3;
    }

    @media (max-width: 600px) {
      #cuisineFilter, #sidebar {
        left: 5%;
        width: 90%;
      }
      #sidebar { top: 60px; font-size: 12px; }
    }
  </style>
</head>
<body>
  <select id="cuisineFilter">
    <option value="">Select Cuisine</option>
    <option value="Brazilian">Brazilian</option>
    <option value="Portuguese">Portuguese</option>
    <option value="Spanish">Spanish</option>
    <option value="Latin American">Latin American</option>
    <option value="American, Southern/Soul Food, European">American, Southern/Soul Food, European</option>
    <option value="African, Caribbean, Middle Eastern">African, Caribbean, Middle Eastern</option>
    <option value="Churrasco/Portuguese BBQ">Churrasco/Portuguese BBQ</option>
    <option value="Cafes, Bakeries, Dessert">Cafes, Bakeries, Dessert</option>
    <option value="Asian">Asian</option>
    <option value="clear">Clear Sidebar/Popups</option>
  </select>
  <div id="sidebar"></div>
  <div id="map"></div>

  <script>
    mapboxgl.accessToken = 'pk.eyJ1IjoicmdhbmRvbGZmIiwiYSI6ImNtaDZhemZjMzBnbjQyanB0NHg2ZHJjZ3oifQ.3cv8mTmaVf2IHnG5TjCirQ';

    // Broad bounds for Newark area — adjust as needed to cover your dataset
    const CITY_BOUNDS = new mapboxgl.LngLatBounds(
      [-74.25, 40.68], // SW
      [-74.10, 40.80]  // NE
    );

    const map = new mapboxgl.Map({
      container: 'map',
      style: 'mapbox://styles/rgandolff/cmhfg9uf700gp01qw8vgc8q6l',
      projection: 'globe',
      zoom: 12,
      center: [-74.17125487497198, 40.74820109384346],
      prefetchZoomDelta: 2
    });

    map.addControl(new mapboxgl.NavigationControl());
    map.scrollZoom.enable();

    const layers = [
      { id: 'brazilian-restaurant-reviews', cuisine: 'Brazilian', sourceLayer: 'Brazilian_Restaurant_Reviews' },
      { id: 'portuguese-restaurant-reviews', cuisine: 'Portuguese', sourceLayer: 'Portuguese_Restaurant_Reviews' },
      { id: 'spanish-restaurant-reviews', cuisine: 'Spanish', sourceLayer: 'Spanish_Restaurant_Reviews' },
      { id: 'latin-american-restaurants', cuisine: 'Latin American', sourceLayer: 'Latin_American_Restaurants' },
      { id: 'american-southernsoul-food-europ', cuisine: 'American, Southern/Soul Food, European', sourceLayer: 'American_SouthernSoul_Food_Europ' },
      { id: 'african-caribbean-middle-eastern', cuisine: 'African, Caribbean, Middle Eastern', sourceLayer: 'African_Caribbean_Middle_Eastern' },
      { id: 'churrasco-portuguese-bbq-restau', cuisine: 'Churrasco/Portuguese BBQ', sourceLayer: 'Churrasco__Portuguese_BBQ_Restau' },
      { id: 'cafes-bakeries-dessert', cuisine: 'Cafes, Bakeries, Dessert', sourceLayer: 'Cafes_Bakeries__Dessert' },
      { id: 'asian-restaurants', cuisine: 'Asian', sourceLayer: 'Asian_Restaurants' }
    ];

    let activePopups = [];

    function clearAll() {
      document.getElementById('sidebar').innerHTML = '';
      activePopups.forEach(p => p.remove());
      activePopups = [];
    }

    function createPopupHTML(name, rating, review) {
      const reviewId = `review-${Math.random().toString(36).substr(2, 9)}`;
      return `
        <strong>${name}</strong><br>⭐ ${rating}<br>
        <a href="#" onclick="document.getElementById('${reviewId}').style.display='block'; this.style.display='none'; return false;">Show review</a>
        <div id="${reviewId}" style="display:none; margin-top:4px; font-size:11px;">${review}</div>
      `;
    }

    function updateSidebar(features) {
      const sidebar = document.getElementById('sidebar');
      sidebar.innerHTML = '';
      if (!features.length) {
        sidebar.innerHTML = '<p>No matching restaurants found.</p>';
        return;
      }
      features.forEach(feature => {
        const name = feature.properties.name || 'Unnamed';
        const rating = feature.properties.rating ? `${feature.properties.rating}` : 'No rating';
        const review = feature.properties.review || 'No review available';
        const coords = feature.geometry.coordinates;

        const item = document.createElement('div');
        item.className = 'restaurant-item';
        item.innerHTML = `<strong>${name}</strong> — ${rating}`;
        item.onclick = () => {
          // Zoom and show popup with toggleable review
          map.easeTo({ center: coords, zoom: 14 });
          const popup = new mapboxgl.Popup()
            .setLngLat(coords)
            .setHTML(createPopupHTML(name, rating, review))
            .addTo(map);
          activePopups.push(popup);
        };
        sidebar.appendChild(item);
      });
    }

    // Fit to broad bounds and wait for idle before querying
    function fitAndQuery(sourceLayer) {
      return new Promise(resolve => {
        map.fitBounds(CITY_BOUNDS, { padding: 30, duration: 300 });
        map.once('idle', () => {
          const features = map.querySourceFeatures('composite', { sourceLayer });
          resolve(features);
        });
      });
    }

    map.on('style.load', () => {
      map.setFog({});

      // Map clicks: update sidebar and show interactive popup
      layers.forEach(({ id }) => {
        map.on('click', id, (e) => {
          clearAll();
          const feature = e.features[0];
          updateSidebar([feature]);
          const coords = feature.geometry.coordinates;
          const name = feature.properties.name || 'Unnamed';
          const rating = feature.properties.rating ? `${feature.properties.rating}` : 'No rating';
          const review = feature.properties.review || 'No review available';

          map.easeTo({ center: coords, zoom: 14 });
          const popup = new mapboxgl.Popup()
            .setLngLat(coords)
            .setHTML(createPopupHTML(name, rating, review))
            .addTo(map);
          activePopups.push(popup);
        });

        map.on('mouseenter', id, () => map.getCanvas().style.cursor = 'pointer');
        map.on('mouseleave', id, () => map.getCanvas().style.cursor = '');
      });

      // Dropdown behavior with clear + robust querying
      const filterEl = document.getElementById('cuisineFilter');
      filterEl.addEventListener('change', async (e) => {
        const selected = e.target.value;

        if (!selected) return;

        if (selected === 'clear') {
          clearAll();
          filterEl.selectedIndex = 0;
          return;
        }

        clearAll();
        const layerInfo = layers.find(l => l.cuisine === selected);
        if (!layerInfo) { filterEl.selectedIndex = 0; return; }

        // Fit to broad area and wait for tiles to load, then query
        const features = await fitAndQuery(layerInfo.sourceLayer);

        updateSidebar(features);

        if (features.length) {
          const bounds = new mapboxgl.LngLatBounds();
          features.forEach(f => bounds.extend(f.geometry.coordinates));
          map.fitBounds(bounds, { padding: 40, duration: 500 });
        } else {
          document.getElementById('sidebar').innerHTML = '<p>No matching restaurants found.</p>';
        }

        filterEl.selectedIndex = 0;
      });
    });
  </script>
</body>
</html>
