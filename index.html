<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <title>Brick City Bite Newark Food Map</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <link href="https://api.mapbox.com/mapbox-gl-js/v3.16.0/mapbox-gl.css" rel="stylesheet">
  <script src="https://api.mapbox.com/mapbox-gl-js/v3.16.0/mapbox-gl.js"></script>
  <style>
    body {
      margin: 0;
      padding: 0;
      font-family: sans-serif;
      display: flex;
      flex-direction: column;
      height: 100vh;
    }

    /* Compact header with dropdown + sidebar */
    #header {
      background: #fff;
      padding: 6px;
      border-bottom: 1px solid #ccc;
      z-index: 2;
      display: flex;
      gap: 8px;
      align-items: flex-start;
    }

    #cuisineFilter {
      padding: 4px;
      font-size: 13px;
      border: 1px solid #ccc;
      border-radius: 4px;
      background: white;
      max-width: 160px;
    }

    /* Sidebar docked in header, compact */
    #sidebar {
      flex: 1;
      max-height: 120px; /* smaller height for mobile */
      overflow-y: auto;
      background: rgba(255, 255, 255, 0.95);
      border-radius: 4px;
      padding: 4px;
      font-size: 12px;
      box-shadow: 0 0 2px rgba(0,0,0,0.2);
    }

    .restaurant-item {
      margin-bottom: 4px;
      padding: 2px 0;
      border-bottom: 1px solid #eee;
      cursor: pointer;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }
    .restaurant-item:hover { background: #f9f9f9; }

    .mapboxgl-popup-content {
      max-width: 220px;
      padding: 6px;
      font-size: 12px;
      line-height: 1.3;
    }

    /* Map fills remaining space */
    #map {
      flex: 1;
      width: 100%;
      position: relative;
    }

    @media (max-width: 600px) {
      #header {
        flex-direction: column;
        gap: 6px;
      }
      #cuisineFilter, #sidebar {
        width: 100%;
        max-width: none;
      }
      #sidebar {
        max-height: 100px;
        font-size: 11px;
      }
    }
  </style>
</head>
<body>
  <!-- Header with dropdown and sidebar side by side -->
  <div id="header">
    <select id="cuisineFilter">
      <option value="">Select Cuisine</option>
      <option value="Brazilian">Brazilian</option>
      <option value="Portuguese">Portuguese</option>
      <option value="Spanish">Spanish</option>
      <option value="Latin American">Latin American</option>
      <option value="American, Southern/Soul Food, European">American, Southern/Soul Food, European</option>
      <option value="African, Caribbean, Middle Eastern">African, Caribbean, Middle Eastern</option>
      <option value="Churrasco/Portuguese BBQ">Churrasco/Portuguese BBQ</option>
      <option value="Cafes, Bakeries, Dessert">Cafes, Bakeries, Dessert</option>
      <option value="Asian">Asian</option>
      <option value="clear">Clear Sidebar/Popups</option>
    </select>
    <div id="sidebar"></div>
  </div>

  <!-- Map below header -->
  <div id="map"></div>

  <script>
    mapboxgl.accessToken = 'pk.eyJ1IjoicmdhbmRvbGZmIiwiYSI6ImNtaDZhemZjMzBnbjQyanB0NHg2ZHJjZ3oifQ.3cv8mTmaVf2IHnG5TjCirQ';

    const CITY_BOUNDS = new mapboxgl.LngLatBounds(
      [-74.25, 40.68],
      [-74.10, 40.80]
    );

    const map = new mapboxgl.Map({
      container: 'map',
      style: 'mapbox://styles/rgandolff/cmhfg9uf700gp01qw8vgc8q6l',
      projection: 'globe',
      zoom: 12,
      center: [-74.17125487497198, 40.74820109384346],
      prefetchZoomDelta: 2
    });

    map.addControl(new mapboxgl.NavigationControl());
    map.scrollZoom.enable();

    const layers = [
      { id: 'brazilian-restaurant-reviews', cuisine: 'Brazilian', sourceLayer: 'Brazilian_Restaurant_Reviews' },
      { id: 'portuguese-restaurant-reviews', cuisine: 'Portuguese', sourceLayer: 'Portuguese_Restaurant_Reviews' },
      { id: 'spanish-restaurant-reviews', cuisine: 'Spanish', sourceLayer: 'Spanish_Restaurant_Reviews' },
      { id: 'latin-american-restaurants', cuisine: 'Latin American', sourceLayer: 'Latin_American_Restaurants' },
      { id: 'american-southernsoul-food-europ', cuisine: 'American, Southern/Soul Food, European', sourceLayer: 'American_SouthernSoul_Food_Europ' },
      { id: 'african-caribbean-middle-eastern', cuisine: 'African, Caribbean, Middle Eastern', sourceLayer: 'African_Caribbean_Middle_Eastern' },
      { id: 'churrasco-portuguese-bbq-restau', cuisine: 'Churrasco/Portuguese BBQ', sourceLayer: 'Churrasco__Portuguese_BBQ_Restau' },
      { id: 'cafes-bakeries-dessert', cuisine: 'Cafes, Bakeries, Dessert', sourceLayer: 'Cafes_Bakeries__Dessert' },
      { id: 'asian-restaurants', cuisine: 'Asian', sourceLayer: 'Asian_Restaurants' }
    ];

    let activePopups = [];

    function clearAll() {
      document.getElementById('sidebar').innerHTML = '';
      activePopups.forEach(p => p.remove());
      activePopups = [];
    }

    function createPopupHTML(name, rating, review, address) {
      const reviewId = `review-${Math.random().toString(36).substr(2, 9)}`;
      return `
        <strong>${name}</strong><br>
        ${address}<br>
        ⭐ ${rating}<br>
        <a href="#" onclick="document.getElementById('${reviewId}').style.display='block'; this.style.display='none'; return false;">Show review</a>
        <div id="${reviewId}" style="display:none; margin-top:4px; font-size:11px;">${review}</div>
      `;
    }

    function updateSidebar(features) {
      const sidebar = document.getElementById('sidebar');
      sidebar.innerHTML = '';
      if (!features.length) {
        sidebar.innerHTML = '<p>No matching restaurants found.</p>';
        return;
      }
      features.forEach(feature => {
        const name = feature.properties.name || 'Unnamed';
        const rating = feature.properties.rating ? `${feature.properties.rating}` : 'No rating';
        const review = feature.properties.review || 'No review available';
        const address = feature.properties.address || 'Address not available';
        const coords = feature.geometry.coordinates;

        const item = document.createElement('div');
        item.className = 'restaurant-item';
        // Compact one-line format
        item.innerHTML = `${name} — ⭐ ${rating} — ${address}`;
        item.onclick = () => {
          // Zoom only when sidebar item is clicked
          map.easeTo({ center: coords, zoom: 14 });
          const popup = new mapboxgl.Popup()
            .setLngLat(coords)
            .setHTML(createPopupHTML(name, rating, review, address))
            .addTo(map);
          activePopups.push(popup);
        };
        sidebar.appendChild(item);
      });
    }

    function fitAndQuery(sourceLayer) {
      return new Promise(resolve => {
        map.fitBounds(CITY_BOUNDS, { padding: 30, duration: 300 });
        map.once('idle', () => {
          const features = map.querySourceFeatures('composite', { sourceLayer });
          resolve(features);
        });
      });
    }

    map.on('style.load', () => {
      map.setFog({});

      layers.forEach(({ id }) => {
        map.on('click', id, (e) => {
          clearAll();
          const feature = e.features[0];
          updateSidebar([feature]);
          const coords = feature.geometry.coordinates;
          const name = feature.properties.name || 'Unnamed';
          const rating = feature.properties.rating ? `${feature.properties.rating}` : 'No rating';
          const review = feature.properties.review || 'No review available';
                    const address = feature.properties.address || 'Address not available';

          // Marker click: only show popup, no zoom reset
          const popup = new mapboxgl.Popup()
            .setLngLat(coords)
            .setHTML(createPopupHTML(name, rating, review, address))
            .addTo(map);
          activePopups.push(popup);
        });

        map.on('mouseenter', id, () => map.getCanvas().style.cursor = 'pointer');
        map.on('mouseleave', id, () => map.getCanvas().style.cursor = '');
      });

      const filterEl = document.getElementById('cuisineFilter');
      filterEl.addEventListener('change', async (e) => {
        const selected = e.target.value;
        if (!selected) return;

        if (selected === 'clear') {
          clearAll();
          filterEl.selectedIndex = 0;
          return;
        }

        clearAll();
        const layerInfo = layers.find(l => l.cuisine === selected);
        if (!layerInfo) { filterEl.selectedIndex = 0; return; }

        // Fit to broad area and wait for tiles to load, then query
        const features = await fitAndQuery(layerInfo.sourceLayer);

        updateSidebar(features);

        if (features.length) {
          const bounds = new mapboxgl.LngLatBounds();
          features.forEach(f => bounds.extend(f.geometry.coordinates));
          map.fitBounds(bounds, { padding: 40, duration: 500 });
        } else {
          const sidebar = document.getElementById('sidebar');
          sidebar.innerHTML = '<p>No matching restaurants found.</p>';
        }

        filterEl.selectedIndex = 0;
      });
    });
  </script>
</body>
</html>
